<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - JastipYntsr</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f7f7ff;
    }
    .card {
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }
    .btn-primary {
      background-color: #ff4da6;
      border: none;
      font-weight: 600;
      transition: 0.3s;
    }
    .btn-primary:hover {
      background-color: #e33e92;
      transform: scale(1.03);
    }
    .btn-warning {
      color: white;
    }
    .btn-danger {
      color: white;
    }
    .table thead {
      background-color: #ff4da6;
      color: white;
    }
    .preview-img {
      height: 60px;
      border-radius: 5px;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4 text-center fw-bold text-primary">Admin Panel - JastipYntsr</h2>

    <!-- Form Tambah / Edit Produk -->
    <form id="form-produk" class="card p-4 mb-5">
      <h5 id="form-title" class="mb-3">Tambah Produk Baru</h5>

      <!-- Upload Foto -->
      <div class="mb-3">
        <label class="form-label">Foto Produk</label>
        <input type="file" id="foto" class="form-control" accept="image/*">
        <div id="preview-container" class="mt-2"></div>
      </div>

      <!-- Nama Produk -->
      <div class="mb-3">
        <label class="form-label">Nama Produk</label>
        <input type="text" id="nama" class="form-control" placeholder="Masukkan nama produk" required>
      </div>

      <!-- Harga Produk -->
      <div class="mb-3">
        <label class="form-label">Harga Produk (Rp)</label>
        <input type="number" id="harga" class="form-control" placeholder="Contoh: 150000" required>
      </div>

      <!-- Kategori -->
      <div class="mb-3">
        <label class="form-label">Kategori</label>
        <select id="kategori" class="form-select" required>
          <option value="">Pilih Kategori</option>
          <option value="skincare">Skincare</option>
          <option value="fashion">Fashion</option>
          <option value="makanan">Makanan</option>
          <option value="lainnya">Lainnya</option>
        </select>
      </div>

      <!-- Tombol -->
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary w-100" id="submit-btn">Simpan Produk</button>
        <button type="button" class="btn btn-secondary w-50 d-none" id="cancel-edit">Batal Edit</button>
      </div>
    </form>

    <!-- Status -->
    <div id="status" class="mb-4 text-center"></div>

    <!-- Tabel Produk -->
    <div class="card p-4">
      <h5 class="mb-3">Daftar Produk Tersimpan</h5>
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead>
            <tr>
              <th>Foto</th>
              <th>Nama Produk</th>
              <th>Harga</th>
              <th>Kategori</th>
              <th class="text-center">Aksi</th>
            </tr>
          </thead>
          <tbody id="produk-tabel"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDYlo4dhx7poDN0nkb9fU5N7jUcK_KR06E",
      authDomain: "jastip-yntsr-2a7f3.firebaseapp.com",
      projectId: "jastip-yntsr-2a7f3",
      storageBucket: "jastip-yntsr-2a7f3.appspot.com",
      messagingSenderId: "483670423997",
      appId: "1:483670423997:web:d23562be2cbdf1e793fad4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const form = document.getElementById("form-produk");
    const statusDiv = document.getElementById("status");
    const tabelProduk = document.getElementById("produk-tabel");
    const previewContainer = document.getElementById("preview-container");
    const formTitle = document.getElementById("form-title");
    const submitBtn = document.getElementById("submit-btn");
    const cancelEditBtn = document.getElementById("cancel-edit");

    let editId = null;
    let currentFoto = "";

    // Preview foto
    document.getElementById("foto").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        previewContainer.innerHTML = `<img src="${url}" class="preview-img" />`;
      }
    });

    // Tambah atau Edit Produk
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const fotoFile = document.getElementById("foto").files[0];
      const nama = document.getElementById("nama").value.trim();
      const harga = parseInt(document.getElementById("harga").value);
      const kategori = document.getElementById("kategori").value;

      try {
        let fotoURL = currentFoto;

        // Upload foto baru jika ada
        if (fotoFile) {
          const storageRef = ref(storage, `produk/${Date.now()}-${fotoFile.name}`);
          await uploadBytes(storageRef, fotoFile);
          fotoURL = await getDownloadURL(storageRef);
        }

        if (editId) {
          // Update produk
          const docRef = doc(db, "produk", editId);
          await updateDoc(docRef, { foto: fotoURL, nama, harga, kategori });
          statusDiv.innerHTML = `<div class="alert alert-success">Produk berhasil diperbarui!</div>`;
        } else {
          // Tambah produk baru
          await addDoc(collection(db, "produk"), { foto: fotoURL, nama, harga, kategori });
          statusDiv.innerHTML = `<div class="alert alert-success">Produk berhasil disimpan!</div>`;
        }

        form.reset();
        previewContainer.innerHTML = "";
        formTitle.textContent = "Tambah Produk Baru";
        submitBtn.textContent = "Simpan Produk";
        cancelEditBtn.classList.add("d-none");
        editId = null;
        currentFoto = "";

        loadProduk();
      } catch (error) {
        console.error("Gagal menyimpan produk:", error);
        statusDiv.innerHTML = `<div class="alert alert-danger">Gagal menyimpan produk: ${error.message}</div>`;
      }
    });

    // Load Produk ke Tabel
    async function loadProduk() {
      tabelProduk.innerHTML = "";
      const querySnapshot = await getDocs(collection(db, "produk"));
      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        tabelProduk.innerHTML += `
          <tr>
            <td><img src="${data.foto}" class="preview-img"></td>
            <td>${data.nama}</td>
            <td>Rp ${data.harga.toLocaleString()}</td>
            <td>${data.kategori || '-'}</td>
            <td class="text-center">
              <button class="btn btn-warning btn-sm" onclick="editProduk('${docSnap.id}', '${data.foto}', '${data.nama}', ${data.harga}, '${data.kategori}')">‚úèÔ∏è Edit</button>
              <button class="btn btn-danger btn-sm" onclick="hapusProduk('${docSnap.id}')">üóëÔ∏è Hapus</button>
            </td>
          </tr>
        `;
      });
    }

    // Edit Produk
    window.editProduk = (id, foto, nama, harga, kategori) => {
      editId = id;
      currentFoto = foto;
      document.getElementById("nama").value = nama;
      document.getElementById("harga").value = harga;
      document.getElementById("kategori").value = kategori;
      previewContainer.innerHTML = `<img src="${foto}" class="preview-img" />`;
      formTitle.textContent = "Edit Produk";
      submitBtn.textContent = "Update Produk";
      cancelEditBtn.classList.remove("d-none");
    };

    // Hapus Produk
    window.hapusProduk = async (id) => {
      if (confirm("Yakin mau hapus produk ini?")) {
        await deleteDoc(doc(db, "produk", id));
        statusDiv.innerHTML = `<div class="alert alert-success">Produk berhasil dihapus!</div>`;
        loadProduk();
      }
    };

    // Batal Edit
    cancelEditBtn.addEventListener("click", () => {
      editId = null;
      currentFoto = "";
      form.reset();
      previewContainer.innerHTML = "";
      formTitle.textContent = "Tambah Produk Baru";
      submitBtn.textContent = "Simpan Produk";
      cancelEditBtn.classList.add("d-none");
    });

    // Load awal
    loadProduk();
  </script>
</body>
</html>
